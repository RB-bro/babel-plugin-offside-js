'use strict';

const assert = require('assert');
const babylon = require('babylon');
const tt = babylon.tokTypes;

var _g_offsidePluginOpts;
const default_offsidePluginOpts = { keyword_blocks: true };

const _base_module_parse = babylon.parse;
babylon.parse = (input, options) => {
  _g_offsidePluginOpts = options ? options.offsidePluginOpts : undefined;
  return _base_module_parse(input, options);
};

const Parser = hookBabylon();
const baseProto = Parser.prototype;
const pp = Parser.prototype = Object.create(baseProto);

function hookBabylon() {
  // abuse Babylon token updateContext callback extract
  // the reference to Parser

  let Parser;
  let tgt_patch = babylon.tokTypes.braceL;
  let fn_updateContext = tgt_patch.updateContext;
  tgt_patch.updateContext = function (prevType) {
    tgt_patch.updateContext = fn_updateContext;
    Parser = this.constructor;
  };

  babylon.parse('{}');
  if (!Parser) {
    throw new Error("Failed to hook Babylon Parser");
  }
  return Parser;
}

pp._base_parse = baseProto.parse;
pp.parse = function () {
  this.initOffside();
  return this._base_parse();
};

class OffsideBreakout extends Error {}
const offsideBreakout = new OffsideBreakout();

pp.initOffside = function () {
  this.state.offside = [];
  this.state.offsideNextOp = null;
  this.offside_lines = parseOffsideIndexMap(this.input);
  this.offsidePluginOpts = _g_offsidePluginOpts || {};
  _g_offsidePluginOpts = null;

  this.state._pos = this.state.pos;
  Object.defineProperty(this.state, 'pos', { enumerable: true,
    get() {
      return this._pos;
    }, set(pos) {
      // interrupt skipSpace algorithm when we hit our position 'breakpoint'
      let offPos = this.offsidePos;
      if (offPos >= 0 && pos > offPos) {
        throw offsideBreakout;
      }

      this._pos = pos;
    } });
};

let tt_offside = { '{': tt.braceL, '}': tt.braceR,
  '(': tt.parenL, ')': tt.parenR,
  '[': tt.bracketL, ']': tt.bracketR };

let tt_offside_keyword_with_args = new Set([tt._if, tt._while, tt._for, tt._catch, tt._switch]);

let tt_offside_keyword_lookahead_skip = new Set([tt.parenL, tt.colon, tt.comma, tt.dot]);

let at_offside = { '::': { tokenPre: '{', tokenPost: '}', nestInner: false, codeBlock: true },
  '::@': { tokenPre: '(', tokenPost: ')', nestInner: false, extraChars: 1 },
  '::()': { tokenPre: '(', tokenPost: ')', nestInner: false, extraChars: 2 },
  '::{}': { tokenPre: '{', tokenPost: '}', nestInner: false, extraChars: 2 },
  '::[]': { tokenPre: '[', tokenPost: ']', nestInner: false, extraChars: 2 },
  '@': { tokenPre: '(', tokenPost: ')', nestInner: true },
  '@()': { tokenPre: '{', tokenPost: '}', nestInner: true, extraChars: 2 },
  '@{}': { tokenPre: '{', tokenPost: '}', nestInner: true, extraChars: 2 },
  '@[]': { tokenPre: '[', tokenPost: ']', nestInner: true, extraChars: 2 }
  // note:  no '@()' -- standardize to use single-char '@ ' instead
  , keyword_args: { tokenPre: '(', tokenPost: ')', nestInner: false, inKeywordArg: true } };

pp._base_finishToken = baseProto.finishToken;
pp.finishToken = function (type, val) {
  const state = this.state;
  state.offsideRecentOp = null;

  if (tt_offside_keyword_with_args.has(type)) {
    let isKeywordAllowed = !this.isLookahead && tt.dot !== state.type;

    if (!isKeywordAllowed) {
      return this._base_finishToken(type, val);
    }

    const lookahead = this.lookahead();

    if (!tt_offside_keyword_lookahead_skip.has(lookahead.type)) {
      state.offsideNextOp = at_offside.keyword_args;
    } else if (lookahead.offsideRecentOp === at_offside['@']) {
      state.offsideNextOp = at_offside.keyword_args;
    }

    return this._base_finishToken(type, val);
  }

  if (type === tt.at || type === tt.doubleColon) {
    const pos0 = state.start,
          pos1 = state.pos + 2;
    const str_op = this.input.slice(pos0, pos1).split(/\s/, 1)[0];

    const op = at_offside[str_op];
    if (op) {
      return this.finishOffsideOp(op);
    }
  }

  if (tt.eof === type) {
    if (state.offside.length) {
      return this.popOffside();
    }
  }

  return this._base_finishToken(type, val);
};

pp.offsideBlock = function (op, stackTop) {
  let offside_lines = this.offside_lines;

  const line0 = this.state.curLine;
  const first = offside_lines[line0];
  const nestInner = op.nestInner && stackTop && line0 === stackTop.first.line;
  const indent = nestInner ? stackTop.innerIndent : first.indent;
  let line = 1 + line0,
      last = first;
  let innerIndent = offside_lines[line].indent;

  while (line < offside_lines.length) {
    let cur = offside_lines[line];
    if (cur.content && indent >= cur.indent) {
      break;
    }

    line++;last = cur;
    if (innerIndent > cur.indent) {
      innerIndent = cur.indent;
    }
  }

  // cap to 
  innerIndent = first.indent > innerIndent ? first.indent : innerIndent;

  return { op, innerIndent, first, last, nestInner };
};

pp.finishOffsideOp = function (op) {
  this.state.offsideRecentOp = op;
  const stack = this.state.offside;
  let stackTop = stack[stack.length - 1];
  if (stackTop && stackTop.inKeywordArg && op.codeBlock) {
    this.popOffside();
    this.state.offsideNextOp = op;
    return;
  }

  if (op.extraChars) {
    this.state.pos += op.extraChars;
  }

  this._base_finishToken(tt_offside[op.tokenPre]);

  if (this.isLookahead) {
    return;
  }

  stackTop = stack[stack.length - 1];
  let blk = this.offsideBlock(op, stackTop);
  blk.inKeywordArg = op.inKeywordArg || stackTop && stackTop.inKeywordArg;
  this.state.offside.push(blk);
};

pp._base_skipSpace = baseProto.skipSpace;
pp.skipSpace = function () {
  if (null !== this.state.offsideNextOp) {
    return;
  }

  const stack = this.state.offside;
  let stackTop;
  if (stack && stack.length) {
    stackTop = stack[stack.length - 1];
    this.state.offsidePos = stackTop.last.posLastContent;
  } else {
    this.state.offsidePos = -1;
  }

  try {
    this._base_skipSpace();
    this.state.offsidePos = -1;
  } catch (err) {
    if (err !== offsideBreakout) {
      throw err;
    }
  }
};

pp._base_readToken = baseProto.readToken;
pp.readToken = function (code) {
  const offsideNextOp = this.state.offsideNextOp;
  if (null !== offsideNextOp) {
    this.state.offsideNextOp = null;
    return this.finishOffsideOp(offsideNextOp);
  } else if (this.state.pos === this.state.offsidePos) {
    return this.popOffside();
  } else {
    return this._base_readToken(code);
  }
};

pp.popOffside = function () {
  const stack = this.state.offside;
  let stackTop = this.isLookahead ? stack[stack.length - 1] : stack.pop();
  this.state.offsidePos = -1;

  const op = stackTop.op;
  const tt_post = tt_offside[op.tokenPost];
  this._base_finishToken(tt_post);
  return stackTop;
};

const rx_offside = /^([ \t]*)(.*)$/mg;
function parseOffsideIndexMap(input) {
  let lines = [null],
      posLastContent = 0,
      last = ['', 0];

  let ans = input.replace(rx_offside, (match, indent, content, pos) => {
    if (!content) {
      [indent, posLastContent] = last; // blank line; use last valid content as end
    } else {
        // valid content; set last to current indent
        posLastContent = pos + match.length;
        last = [indent, posLastContent];
      }

    lines.push({ line: lines.length, posLastContent, indent, content });
    return '';
  });

  return lines;
}

const keyword_block_parents = { IfStatement: 'if',
  ForStatement: 'for',
  WhileStatement: 'while',
  DoWhileStatement: 'do-while' };
const lint_keyword_block_parents = new Set(Object.keys(keyword_block_parents));

const babel_plugin_id = `babel-plugin-offside--${Date.now()}`;
module.exports = exports = babel => {
  return {
    name: babel_plugin_id,
    post(state) {
      //console.dir @ state, @{} colors: true
    }, manipulateOptions(opts, parserOpts) {
      parserOpts.plugins.push('decorators', 'functionBind');
      const offsidePluginOpts = opts.plugins.filter(plugin => plugin[0] && babel_plugin_id === plugin[0].key).map(plugin => plugin[1]).pop();
      parserOpts.offsidePluginOpts = offsidePluginOpts || default_offsidePluginOpts;
    }, visitor: {
      ExpressionStatement(path) {
        if (!this.opts.keyword_blocks) {
          return;
        }
        if (!lint_keyword_block_parents.has(path.parent.type)) {
          return;
        }

        let keyword = keyword_block_parents[path.parent.type];
        if ('if' === keyword && path.node === path.parent.alternate) {
          keyword = 'else'; // fixup if/else combined parent condition
        }throw path.buildCodeFrameError(`Keyword '${keyword}' should be followed by a block statement using '::' or matching '{' / '}'. \n` + `    (From 'keyword_blocks' enforcement option of babel-plugin-offside)`);
      } } };
};

Object.assign(exports, {
  hookBabylon,
  parseOffsideIndexMap });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2NvZGUvaW5kZXguanMiXSwibmFtZXMiOlsiYXNzZXJ0IiwicmVxdWlyZSIsImJhYnlsb24iLCJ0dCIsInRva1R5cGVzIiwiX2dfb2Zmc2lkZVBsdWdpbk9wdHMiLCJkZWZhdWx0X29mZnNpZGVQbHVnaW5PcHRzIiwia2V5d29yZF9ibG9ja3MiLCJfYmFzZV9tb2R1bGVfcGFyc2UiLCJwYXJzZSIsImlucHV0Iiwib3B0aW9ucyIsIm9mZnNpZGVQbHVnaW5PcHRzIiwidW5kZWZpbmVkIiwiUGFyc2VyIiwiaG9va0JhYnlsb24iLCJiYXNlUHJvdG8iLCJwcm90b3R5cGUiLCJwcCIsIk9iamVjdCIsImNyZWF0ZSIsInRndF9wYXRjaCIsImJyYWNlTCIsImZuX3VwZGF0ZUNvbnRleHQiLCJ1cGRhdGVDb250ZXh0IiwicHJldlR5cGUiLCJjb25zdHJ1Y3RvciIsIkVycm9yIiwiX2Jhc2VfcGFyc2UiLCJpbml0T2Zmc2lkZSIsIk9mZnNpZGVCcmVha291dCIsIm9mZnNpZGVCcmVha291dCIsInN0YXRlIiwib2Zmc2lkZSIsIm9mZnNpZGVOZXh0T3AiLCJvZmZzaWRlX2xpbmVzIiwicGFyc2VPZmZzaWRlSW5kZXhNYXAiLCJfcG9zIiwicG9zIiwiZGVmaW5lUHJvcGVydHkiLCJlbnVtZXJhYmxlIiwiZ2V0Iiwic2V0Iiwib2ZmUG9zIiwib2Zmc2lkZVBvcyIsInR0X29mZnNpZGUiLCJicmFjZVIiLCJwYXJlbkwiLCJwYXJlblIiLCJicmFja2V0TCIsImJyYWNrZXRSIiwidHRfb2Zmc2lkZV9rZXl3b3JkX3dpdGhfYXJncyIsIlNldCIsIl9pZiIsIl93aGlsZSIsIl9mb3IiLCJfY2F0Y2giLCJfc3dpdGNoIiwidHRfb2Zmc2lkZV9rZXl3b3JkX2xvb2thaGVhZF9za2lwIiwiY29sb24iLCJjb21tYSIsImRvdCIsImF0X29mZnNpZGUiLCJ0b2tlblByZSIsInRva2VuUG9zdCIsIm5lc3RJbm5lciIsImNvZGVCbG9jayIsImV4dHJhQ2hhcnMiLCJrZXl3b3JkX2FyZ3MiLCJpbktleXdvcmRBcmciLCJfYmFzZV9maW5pc2hUb2tlbiIsImZpbmlzaFRva2VuIiwidHlwZSIsInZhbCIsIm9mZnNpZGVSZWNlbnRPcCIsImhhcyIsImlzS2V5d29yZEFsbG93ZWQiLCJpc0xvb2thaGVhZCIsImxvb2thaGVhZCIsImF0IiwiZG91YmxlQ29sb24iLCJwb3MwIiwic3RhcnQiLCJwb3MxIiwic3RyX29wIiwic2xpY2UiLCJzcGxpdCIsIm9wIiwiZmluaXNoT2Zmc2lkZU9wIiwiZW9mIiwibGVuZ3RoIiwicG9wT2Zmc2lkZSIsIm9mZnNpZGVCbG9jayIsInN0YWNrVG9wIiwibGluZTAiLCJjdXJMaW5lIiwiZmlyc3QiLCJsaW5lIiwiaW5kZW50IiwiaW5uZXJJbmRlbnQiLCJsYXN0IiwiY3VyIiwiY29udGVudCIsInN0YWNrIiwiYmxrIiwicHVzaCIsIl9iYXNlX3NraXBTcGFjZSIsInNraXBTcGFjZSIsInBvc0xhc3RDb250ZW50IiwiZXJyIiwiX2Jhc2VfcmVhZFRva2VuIiwicmVhZFRva2VuIiwiY29kZSIsInBvcCIsInR0X3Bvc3QiLCJyeF9vZmZzaWRlIiwibGluZXMiLCJhbnMiLCJyZXBsYWNlIiwibWF0Y2giLCJrZXl3b3JkX2Jsb2NrX3BhcmVudHMiLCJJZlN0YXRlbWVudCIsIkZvclN0YXRlbWVudCIsIldoaWxlU3RhdGVtZW50IiwiRG9XaGlsZVN0YXRlbWVudCIsImxpbnRfa2V5d29yZF9ibG9ja19wYXJlbnRzIiwia2V5cyIsImJhYmVsX3BsdWdpbl9pZCIsIkRhdGUiLCJub3ciLCJtb2R1bGUiLCJleHBvcnRzIiwiYmFiZWwiLCJuYW1lIiwicG9zdCIsIm1hbmlwdWxhdGVPcHRpb25zIiwib3B0cyIsInBhcnNlck9wdHMiLCJwbHVnaW5zIiwiZmlsdGVyIiwicGx1Z2luIiwia2V5IiwibWFwIiwidmlzaXRvciIsIkV4cHJlc3Npb25TdGF0ZW1lbnQiLCJwYXRoIiwicGFyZW50Iiwia2V5d29yZCIsIm5vZGUiLCJhbHRlcm5hdGUiLCJidWlsZENvZGVGcmFt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dkMsRUFFdkJDLEdBRnVCLENBRWpCRixVQUFVQSxPQUFPLENBQVAsQ0FGTyxFQUd2QjNCLEdBSHVCLEVBQTFCO0FBSUF3QixpQkFBVzdILGlCQUFYLEdBQStCQSxxQkFBcUJOLHlCQUFwRDtBQUE2RSxLQVg1RSxFQWFIeUksU0FBUztBQUNQQywwQkFBb0JDLElBQXBCLEVBQTBCO0FBQ3hCLFlBQUksQ0FBQyxLQUFLVCxJQUFMLENBQVVqSSxjQUFmLEVBQStCO0FBQUc7QUFBTTtBQUN4QyxZQUFJLENBQUNzSCwyQkFBMkJsRCxHQUEzQixDQUErQnNFLEtBQUtDLE1BQUwsQ0FBWTFFLElBQTNDLENBQUwsRUFBdUQ7QUFBRztBQUFNOztBQUVoRSxZQUFJMkUsVUFBVTNCLHNCQUFzQnlCLEtBQUtDLE1BQUwsQ0FBWTFFLElBQWxDLENBQWQ7QUFDQSxZQUFJLFNBQVMyRSxPQUFULElBQW9CRixLQUFLRyxJQUFMLEtBQWNILEtBQUtDLE1BQUwsQ0FBWUcsU0FBbEQsRUFBNkQ7QUFDM0RGLG9CQUFVLE1BQVYsQ0FEMkQsQ0FDMUM7QUFBMEMsU0FFN0QsTUFBTUYsS0FBS0ssbUJBQUwsQ0FDSCxZQUFXSCxPQUFRLGdGQUFwQixHQUNDLHdFQUZHLENBQU47QUFFMEUsT0FYckUsRUFiTixFQUFQO0FBd0JrRixDQXpCcEY7O0FBNEJBaEksT0FBT29JLE1BQVAsQ0FBZ0JwQixPQUFoQixFQUNFO0FBQ0VwSCxhQURGO0FBRUVxQixzQkFGRixFQURGIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5jb25zdCBhc3NlcnQgPSByZXF1aXJlKCdhc3NlcnQnKVxuY29uc3QgYmFieWxvbiA9IHJlcXVpcmUoJ2JhYnlsb24nKVxuY29uc3QgdHQgPSBiYWJ5bG9uLnRva1R5cGVzXG5cbnZhciBfZ19vZmZzaWRlUGx1Z2luT3B0c1xuY29uc3QgZGVmYXVsdF9vZmZzaWRlUGx1Z2luT3B0cyA9XG4gIEB7fSBrZXl3b3JkX2Jsb2NrczogdHJ1ZVxuXG5jb25zdCBfYmFzZV9tb2R1bGVfcGFyc2UgPSBiYWJ5bG9uLnBhcnNlXG5iYWJ5bG9uLnBhcnNlID0gKGlucHV0LCBvcHRpb25zKSA9PiA6OlxuICBfZ19vZmZzaWRlUGx1Z2luT3B0cyA9IG9wdGlvbnMgPyBvcHRpb25zLm9mZnNpZGVQbHVnaW5PcHRzIDogdW5kZWZpbmVkXG4gIHJldHVybiBfYmFzZV9tb2R1bGVfcGFyc2UoaW5wdXQsIG9wdGlvbnMpXG5cbmNvbnN0IFBhcnNlciA9IGhvb2tCYWJ5bG9uKClcbmNvbnN0IGJhc2VQcm90byA9IFBhcnNlci5wcm90b3R5cGVcbmNvbnN0IHBwID0gUGFyc2VyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoYmFzZVByb3RvKVxuXG5mdW5jdGlvbiBob29rQmFieWxvbigpIDo6XG4gIC8vIGFidXNlIEJhYnlsb24gdG9rZW4gdXBkYXRlQ29udGV4dCBjYWxsYmFjayBleHRyYWN0XG4gIC8vIHRoZSByZWZlcmVuY2UgdG8gUGFyc2VyXG5cbiAgbGV0IFBhcnNlclxuICBsZXQgdGd0X3BhdGNoID0gYmFieWxvbi50b2tUeXBlcy5icmFjZUxcbiAgbGV0IGZuX3VwZGF0ZUNvbnRleHQgPSB0Z3RfcGF0Y2gudXBkYXRlQ29udGV4dFxuICB0Z3RfcGF0Y2gudXBkYXRlQ29udGV4dCA9IGZ1bmN0aW9uIChwcmV2VHlwZSkgOjpcbiAgICB0Z3RfcGF0Y2gudXBkYXRlQ29udGV4dCA9IGZuX3VwZGF0ZUNvbnRleHRcbiAgICBQYXJzZXIgPSB0aGlzLmNvbnN0cnVjdG9yXG5cbiAgYmFieWxvbi5wYXJzZSgne30nKVxuICBpZiAoIVBhcnNlcikgOjpcbiAgICB0aHJvdyBuZXcgRXJyb3IgQCBcIkZhaWxlZCB0byBob29rIEJhYnlsb24gUGFyc2VyXCJcbiAgcmV0dXJuIFBhcnNlclxuXG5cblxucHAuX2Jhc2VfcGFyc2UgPSBiYXNlUHJvdG8ucGFyc2VcbnBwLnBhcnNlID0gZnVuY3Rpb24oKSA6OlxuICB0aGlzLmluaXRPZmZzaWRlKClcbiAgcmV0dXJuIHRoaXMuX2Jhc2VfcGFyc2UoKVxuXG5cbmNsYXNzIE9mZnNpZGVCcmVha291dCBleHRlbmRzIEVycm9yIHt9XG5jb25zdCBvZmZzaWRlQnJlYWtvdXQgPSBuZXcgT2Zmc2lkZUJyZWFrb3V0KClcblxucHAuaW5pdE9mZnNpZGUgPSBmdW5jdGlvbigpIDo6XG4gIHRoaXMuc3RhdGUub2Zmc2lkZSA9IFtdXG4gIHRoaXMuc3RhdGUub2Zmc2lkZU5leHRPcCA9IG51bGxcbiAgdGhpcy5vZmZzaWRlX2xpbmVzID0gcGFyc2VPZmZzaWRlSW5kZXhNYXAodGhpcy5pbnB1dClcbiAgdGhpcy5vZmZzaWRlUGx1Z2luT3B0cyA9IF9nX29mZnNpZGVQbHVnaW5PcHRzIHx8IHt9XG4gIF9nX29mZnNpZGVQbHVnaW5PcHRzID0gbnVsbFxuXG4gIHRoaXMuc3RhdGUuX3BvcyA9IHRoaXMuc3RhdGUucG9zXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSBAIHRoaXMuc3RhdGUsICdwb3MnLFxuICAgIEB7fSBlbnVtZXJhYmxlOiB0cnVlXG4gICAgICAsIGdldCgpIDo6IHJldHVybiB0aGlzLl9wb3NcbiAgICAgICwgc2V0KHBvcykgOjpcbiAgICAgICAgICAvLyBpbnRlcnJ1cHQgc2tpcFNwYWNlIGFsZ29yaXRobSB3aGVuIHdlIGhpdCBvdXIgcG9zaXRpb24gJ2JyZWFrcG9pbnQnXG4gICAgICAgICAgbGV0IG9mZlBvcyA9IHRoaXMub2Zmc2lkZVBvc1xuICAgICAgICAgIGlmIChvZmZQb3M+PTAgJiYgKHBvcyA+IG9mZlBvcykpIDo6XG4gICAgICAgICAgICB0aHJvdyBvZmZzaWRlQnJlYWtvdXRcblxuICAgICAgICAgIHRoaXMuX3BvcyA9IHBvc1xuXG5cbmxldCB0dF9vZmZzaWRlID1cbiAgQHt9ICd7JzogdHQuYnJhY2VMLCAgICd9JzogdHQuYnJhY2VSXG4gICAgLCAnKCc6IHR0LnBhcmVuTCwgICAnKSc6IHR0LnBhcmVuUlxuICAgICwgJ1snOiB0dC5icmFja2V0TCwgJ10nOiB0dC5icmFja2V0UlxuXG5sZXQgdHRfb2Zmc2lkZV9rZXl3b3JkX3dpdGhfYXJncyA9IG5ldyBTZXQgQFxuICBAW10gdHQuX2lmLCB0dC5fd2hpbGUsIHR0Ll9mb3JcbiAgICAsIHR0Ll9jYXRjaCwgdHQuX3N3aXRjaFxuXG5sZXQgdHRfb2Zmc2lkZV9rZXl3b3JkX2xvb2thaGVhZF9za2lwID0gbmV3IFNldCBAXG4gIEBbXSB0dC5wYXJlbkwsIHR0LmNvbG9uLCB0dC5jb21tYSwgdHQuZG90XG5cbmxldCBhdF9vZmZzaWRlID1cbiAgQHt9ICc6Oic6ICAge3Rva2VuUHJlOiAneycsIHRva2VuUG9zdDogJ30nLCBuZXN0SW5uZXI6IGZhbHNlLCBjb2RlQmxvY2s6IHRydWV9XG4gICAgLCAnOjpAJzogIHt0b2tlblByZTogJygnLCB0b2tlblBvc3Q6ICcpJywgbmVzdElubmVyOiBmYWxzZSwgZXh0cmFDaGFyczogMX1cbiAgICAsICc6OigpJzoge3Rva2VuUHJlOiAnKCcsIHRva2VuUG9zdDogJyknLCBuZXN0SW5uZXI6IGZhbHNlLCBleHRyYUNoYXJzOiAyfVxuICAgICwgJzo6e30nOiB7dG9rZW5QcmU6ICd7JywgdG9rZW5Qb3N0OiAnfScsIG5lc3RJbm5lcjogZmFsc2UsIGV4dHJhQ2hhcnM6IDJ9XG4gICAgLCAnOjpbXSc6IHt0b2tlblByZTogJ1snLCB0b2tlblBvc3Q6ICddJywgbmVzdElubmVyOiBmYWxzZSwgZXh0cmFDaGFyczogMn1cbiAgICAsICdAJzogICAge3Rva2VuUHJlOiAnKCcsIHRva2VuUG9zdDogJyknLCBuZXN0SW5uZXI6IHRydWV9XG4gICAgLCAnQCgpJzogIHt0b2tlblByZTogJ3snLCB0b2tlblBvc3Q6ICd9JywgbmVzdElubmVyOiB0cnVlLCBleHRyYUNoYXJzOiAyfVxuICAgICwgJ0B7fSc6ICB7dG9rZW5QcmU6ICd7JywgdG9rZW5Qb3N0OiAnfScsIG5lc3RJbm5lcjogdHJ1ZSwgZXh0cmFDaGFyczogMn1cbiAgICAsICdAW10nOiAge3Rva2VuUHJlOiAnWycsIHRva2VuUG9zdDogJ10nLCBuZXN0SW5uZXI6IHRydWUsIGV4dHJhQ2hhcnM6IDJ9XG4gICAgLy8gbm90ZTogIG5vICdAKCknIC0tIHN0YW5kYXJkaXplIHRvIHVzZSBzaW5nbGUtY2hhciAnQCAnIGluc3RlYWRcbiAgICAsIGtleXdvcmRfYXJnczoge3Rva2VuUHJlOiAnKCcsIHRva2VuUG9zdDogJyknLCBuZXN0SW5uZXI6IGZhbHNlLCBpbktleXdvcmRBcmc6IHRydWV9XG5cbnBwLl9iYXNlX2ZpbmlzaFRva2VuID0gYmFzZVByb3RvLmZpbmlzaFRva2VuXG5wcC5maW5pc2hUb2tlbiA9IGZ1bmN0aW9uKHR5cGUsIHZhbCkgOjpcbiAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gIHN0YXRlLm9mZnNpZGVSZWNlbnRPcCA9IG51bGxcblxuICBpZiAodHRfb2Zmc2lkZV9rZXl3b3JkX3dpdGhfYXJncy5oYXModHlwZSkpIDo6XG4gICAgbGV0IGlzS2V5d29yZEFsbG93ZWQgPSAhdGhpcy5pc0xvb2thaGVhZFxuICAgICAgJiYgdHQuZG90ICE9PSBzdGF0ZS50eXBlXG5cbiAgICBpZiAoIWlzS2V5d29yZEFsbG93ZWQpIDo6XG4gICAgICByZXR1cm4gdGhpcy5fYmFzZV9maW5pc2hUb2tlbih0eXBlLCB2YWwpXG5cbiAgICBjb25zdCBsb29rYWhlYWQgPSB0aGlzLmxvb2thaGVhZCgpXG5cbiAgICBpZiAoIXR0X29mZnNpZGVfa2V5d29yZF9sb29rYWhlYWRfc2tpcC5oYXMobG9va2FoZWFkLnR5cGUpKSA6OlxuICAgICAgc3RhdGUub2Zmc2lkZU5leHRPcCA9IGF0X29mZnNpZGUua2V5d29yZF9hcmdzXG4gICAgZWxzZSBpZiAobG9va2FoZWFkLm9mZnNpZGVSZWNlbnRPcCA9PT0gYXRfb2Zmc2lkZVsnQCddKSA6OlxuICAgICAgc3RhdGUub2Zmc2lkZU5leHRPcCA9IGF0X29mZnNpZGUua2V5d29yZF9hcmdzXG5cbiAgICByZXR1cm4gdGhpcy5fYmFzZV9maW5pc2hUb2tlbih0eXBlLCB2YWwpXG5cbiAgaWYgKHR5cGUgPT09IHR0LmF0IHx8IHR5cGUgPT09IHR0LmRvdWJsZUNvbG9uKSA6OlxuICAgIGNvbnN0IHBvczAgPSBzdGF0ZS5zdGFydCwgcG9zMSA9IHN0YXRlLnBvcyArIDJcbiAgICBjb25zdCBzdHJfb3AgPSB0aGlzLmlucHV0LnNsaWNlKHBvczAsIHBvczEpLnNwbGl0KC9cXHMvLCAxKVswXVxuXG4gICAgY29uc3Qgb3AgPSBhdF9vZmZzaWRlW3N0cl9vcF1cbiAgICBpZiAob3ApIDo6IHJldHVybiB0aGlzLmZpbmlzaE9mZnNpZGVPcChvcClcblxuICBpZiAodHQuZW9mID09PSB0eXBlKSA6OlxuICAgIGlmIChzdGF0ZS5vZmZzaWRlLmxlbmd0aCkgOjpcbiAgICAgIHJldHVybiB0aGlzLnBvcE9mZnNpZGUoKVxuXG4gIHJldHVybiB0aGlzLl9iYXNlX2ZpbmlzaFRva2VuKHR5cGUsIHZhbClcblxuXG5cbnBwLm9mZnNpZGVCbG9jayA9IGZ1bmN0aW9uIChvcCwgc3RhY2tUb3ApIDo6XG4gIGxldCBvZmZzaWRlX2xpbmVzID0gdGhpcy5vZmZzaWRlX2xpbmVzXG5cbiAgY29uc3QgbGluZTAgPSB0aGlzLnN0YXRlLmN1ckxpbmVcbiAgY29uc3QgZmlyc3QgPSBvZmZzaWRlX2xpbmVzW2xpbmUwXVxuICBjb25zdCBuZXN0SW5uZXIgPSBvcC5uZXN0SW5uZXIgJiYgc3RhY2tUb3AgJiYgbGluZTAgPT09IHN0YWNrVG9wLmZpcnN0LmxpbmVcbiAgY29uc3QgaW5kZW50ID0gbmVzdElubmVyID8gc3RhY2tUb3AuaW5uZXJJbmRlbnQgOiBmaXJzdC5pbmRlbnRcbiAgbGV0IGxpbmUgPSAxK2xpbmUwLCBsYXN0ID0gZmlyc3RcbiAgbGV0IGlubmVySW5kZW50ID0gb2Zmc2lkZV9saW5lc1tsaW5lXS5pbmRlbnRcblxuICB3aGlsZSAobGluZSA8IG9mZnNpZGVfbGluZXMubGVuZ3RoKSA6OlxuICAgIGxldCBjdXIgPSBvZmZzaWRlX2xpbmVzW2xpbmVdXG4gICAgaWYgKGN1ci5jb250ZW50ICYmIGluZGVudCA+PSBjdXIuaW5kZW50KSA6OlxuICAgICAgYnJlYWtcblxuICAgIGxpbmUrKzsgbGFzdCA9IGN1clxuICAgIGlmIChpbm5lckluZGVudCA+IGN1ci5pbmRlbnQpIDo6XG4gICAgICBpbm5lckluZGVudCA9IGN1ci5pbmRlbnRcblxuICAvLyBjYXAgdG8gXG4gIGlubmVySW5kZW50ID0gZmlyc3QuaW5kZW50ID4gaW5uZXJJbmRlbnRcbiAgICA/IGZpcnN0LmluZGVudCA6IGlubmVySW5kZW50XG5cbiAgcmV0dXJuIHtvcCwgaW5uZXJJbmRlbnQsIGZpcnN0LCBsYXN0LCBuZXN0SW5uZXJ9XG5cblxucHAuZmluaXNoT2Zmc2lkZU9wID0gZnVuY3Rpb24gKG9wKSA6OlxuICB0aGlzLnN0YXRlLm9mZnNpZGVSZWNlbnRPcCA9IG9wXG4gIGNvbnN0IHN0YWNrID0gdGhpcy5zdGF0ZS5vZmZzaWRlXG4gIGxldCBzdGFja1RvcCA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdXG4gIGlmIChzdGFja1RvcCAmJiBzdGFja1RvcC5pbktleXdvcmRBcmcgJiYgb3AuY29kZUJsb2NrKSA6OlxuICAgIHRoaXMucG9wT2Zmc2lkZSgpXG4gICAgdGhpcy5zdGF0ZS5vZmZzaWRlTmV4dE9wID0gb3BcbiAgICByZXR1cm5cblxuICBpZiAob3AuZXh0cmFDaGFycykgOjpcbiAgICB0aGlzLnN0YXRlLnBvcyArPSBvcC5leHRyYUNoYXJzXG5cbiAgdGhpcy5fYmFzZV9maW5pc2hUb2tlbih0dF9vZmZzaWRlW29wLnRva2VuUHJlXSlcblxuICBpZiAodGhpcy5pc0xvb2thaGVhZCkgOjogcmV0dXJuXG5cbiAgc3RhY2tUb3AgPSBzdGFja1tzdGFjay5sZW5ndGggLSAxXVxuICBsZXQgYmxrID0gdGhpcy5vZmZzaWRlQmxvY2sob3AsIHN0YWNrVG9wKVxuICBibGsuaW5LZXl3b3JkQXJnID0gb3AuaW5LZXl3b3JkQXJnIHx8IHN0YWNrVG9wICYmIHN0YWNrVG9wLmluS2V5d29yZEFyZ1xuICB0aGlzLnN0YXRlLm9mZnNpZGUucHVzaChibGspXG5cblxucHAuX2Jhc2Vfc2tpcFNwYWNlID0gYmFzZVByb3RvLnNraXBTcGFjZVxucHAuc2tpcFNwYWNlID0gZnVuY3Rpb24oKSA6OlxuICBpZiAobnVsbCAhPT0gdGhpcy5zdGF0ZS5vZmZzaWRlTmV4dE9wKSA6OiByZXR1cm5cblxuICBjb25zdCBzdGFjayA9IHRoaXMuc3RhdGUub2Zmc2lkZVxuICBsZXQgc3RhY2tUb3BcbiAgaWYgKHN0YWNrICYmIHN0YWNrLmxlbmd0aCkgOjpcbiAgICBzdGFja1RvcCA9IHN0YWNrW3N0YWNrLmxlbmd0aC0xXVxuICAgIHRoaXMuc3RhdGUub2Zmc2lkZVBvcyA9IHN0YWNrVG9wLmxhc3QucG9zTGFzdENvbnRlbnRcbiAgZWxzZSA6OiB0aGlzLnN0YXRlLm9mZnNpZGVQb3MgPSAtMVxuXG4gIHRyeSA6OlxuICAgIHRoaXMuX2Jhc2Vfc2tpcFNwYWNlKClcbiAgICB0aGlzLnN0YXRlLm9mZnNpZGVQb3MgPSAtMVxuICBjYXRjaCAoZXJyKSA6OlxuICAgIGlmIChlcnIgIT09IG9mZnNpZGVCcmVha291dCkgOjogdGhyb3cgZXJyXG5cblxucHAuX2Jhc2VfcmVhZFRva2VuID0gYmFzZVByb3RvLnJlYWRUb2tlblxucHAucmVhZFRva2VuID0gZnVuY3Rpb24oY29kZSkgOjpcbiAgY29uc3Qgb2Zmc2lkZU5leHRPcCA9IHRoaXMuc3RhdGUub2Zmc2lkZU5leHRPcFxuICBpZiAobnVsbCAhPT0gb2Zmc2lkZU5leHRPcCkgOjpcbiAgICB0aGlzLnN0YXRlLm9mZnNpZGVOZXh0T3AgPSBudWxsXG4gICAgcmV0dXJuIHRoaXMuZmluaXNoT2Zmc2lkZU9wKG9mZnNpZGVOZXh0T3ApXG5cbiAgZWxzZSBpZiAodGhpcy5zdGF0ZS5wb3MgPT09IHRoaXMuc3RhdGUub2Zmc2lkZVBvcykgOjpcbiAgICByZXR1cm4gdGhpcy5wb3BPZmZzaWRlKClcblxuICBlbHNlIDo6XG4gICAgcmV0dXJuIHRoaXMuX2Jhc2VfcmVhZFRva2VuKGNvZGUpXG5cbnBwLnBvcE9mZnNpZGUgPSBmdW5jdGlvbigpIDo6XG4gIGNvbnN0IHN0YWNrID0gdGhpcy5zdGF0ZS5vZmZzaWRlXG4gIGxldCBzdGFja1RvcCA9IHRoaXMuaXNMb29rYWhlYWRcbiAgICA/IHN0YWNrW3N0YWNrLmxlbmd0aC0xXVxuICAgIDogc3RhY2sucG9wKClcbiAgdGhpcy5zdGF0ZS5vZmZzaWRlUG9zID0gLTFcblxuICBjb25zdCBvcCA9IHN0YWNrVG9wLm9wXG4gIGNvbnN0IHR0X3Bvc3QgPSB0dF9vZmZzaWRlW29wLnRva2VuUG9zdF1cbiAgdGhpcy5fYmFzZV9maW5pc2hUb2tlbih0dF9wb3N0KVxuICByZXR1cm4gc3RhY2tUb3BcblxuXG5cbmNvbnN0IHJ4X29mZnNpZGUgPSAvXihbIFxcdF0qKSguKikkL21nXG5mdW5jdGlvbiBwYXJzZU9mZnNpZGVJbmRleE1hcChpbnB1dCkgOjpcbiAgbGV0IGxpbmVzID0gW251bGxdLCBwb3NMYXN0Q29udGVudD0wLCBsYXN0PVsnJywgMF1cblxuICBsZXQgYW5zID0gaW5wdXQucmVwbGFjZSBAIHJ4X29mZnNpZGUsIChtYXRjaCwgaW5kZW50LCBjb250ZW50LCBwb3MpID0+IDo6XG4gICAgaWYgKCFjb250ZW50KSA6OlxuICAgICAgW2luZGVudCwgcG9zTGFzdENvbnRlbnRdID0gbGFzdCAvLyBibGFuayBsaW5lOyB1c2UgbGFzdCB2YWxpZCBjb250ZW50IGFzIGVuZFxuICAgIGVsc2UgOjpcbiAgICAgIC8vIHZhbGlkIGNvbnRlbnQ7IHNldCBsYXN0IHRvIGN1cnJlbnQgaW5kZW50XG4gICAgICBwb3NMYXN0Q29udGVudCA9IHBvcyArIG1hdGNoLmxlbmd0aFxuICAgICAgbGFzdCA9IFtpbmRlbnQsIHBvc0xhc3RDb250ZW50XVxuXG4gICAgbGluZXMucHVzaCh7bGluZTogbGluZXMubGVuZ3RoLCBwb3NMYXN0Q29udGVudCwgaW5kZW50LCBjb250ZW50fSlcbiAgICByZXR1cm4gJydcblxuICByZXR1cm4gbGluZXNcblxuXG5jb25zdCBrZXl3b3JkX2Jsb2NrX3BhcmVudHMgPVxuIEB7fSBJZlN0YXRlbWVudDogJ2lmJ1xuICAgLCBGb3JTdGF0ZW1lbnQ6ICdmb3InXG4gICAsIFdoaWxlU3RhdGVtZW50OiAnd2hpbGUnXG4gICAsIERvV2hpbGVTdGF0ZW1lbnQ6ICdkby13aGlsZSdcbmNvbnN0IGxpbnRfa2V5d29yZF9ibG9ja19wYXJlbnRzID0gbmV3IFNldCBAIE9iamVjdC5rZXlzIEAga2V5d29yZF9ibG9ja19wYXJlbnRzXG5cbmNvbnN0IGJhYmVsX3BsdWdpbl9pZCA9IGBiYWJlbC1wbHVnaW4tb2Zmc2lkZS0tJHtEYXRlLm5vdygpfWBcbm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IChiYWJlbCkgPT4gOjpcbiAgcmV0dXJuIDo6XG4gICAgbmFtZTogYmFiZWxfcGx1Z2luX2lkXG4gICAgLCBwb3N0KHN0YXRlKSA6OlxuICAgICAgLy9jb25zb2xlLmRpciBAIHN0YXRlLCBAe30gY29sb3JzOiB0cnVlXG5cbiAgICAsIG1hbmlwdWxhdGVPcHRpb25zKG9wdHMsIHBhcnNlck9wdHMpIDo6XG4gICAgICAgIHBhcnNlck9wdHMucGx1Z2lucy5wdXNoKCdkZWNvcmF0b3JzJywgJ2Z1bmN0aW9uQmluZCcpXG4gICAgICAgIGNvbnN0IG9mZnNpZGVQbHVnaW5PcHRzID0gb3B0cy5wbHVnaW5zXG4gICAgICAgICAgLmZpbHRlciBAIHBsdWdpbiA9PiBwbHVnaW5bMF0gJiYgYmFiZWxfcGx1Z2luX2lkID09PSBwbHVnaW5bMF0ua2V5XG4gICAgICAgICAgLm1hcCBAIHBsdWdpbiA9PiBwbHVnaW5bMV1cbiAgICAgICAgICAucG9wKClcbiAgICAgICAgcGFyc2VyT3B0cy5vZmZzaWRlUGx1Z2luT3B0cyA9IG9mZnNpZGVQbHVnaW5PcHRzIHx8IGRlZmF1bHRfb2Zmc2lkZVBsdWdpbk9wdHNcblxuICAgICwgdmlzaXRvcjogOjpcbiAgICAgICAgRXhwcmVzc2lvblN0YXRlbWVudChwYXRoKSA6OlxuICAgICAgICAgIGlmICghdGhpcy5vcHRzLmtleXdvcmRfYmxvY2tzKSA6OiByZXR1cm5cbiAgICAgICAgICBpZiAoIWxpbnRfa2V5d29yZF9ibG9ja19wYXJlbnRzLmhhcyhwYXRoLnBhcmVudC50eXBlKSkgOjogcmV0dXJuXG5cbiAgICAgICAgICBsZXQga2V5d29yZCA9IGtleXdvcmRfYmxvY2tfcGFyZW50c1twYXRoLnBhcmVudC50eXBlXVxuICAgICAgICAgIGlmICgnaWYnID09PSBrZXl3b3JkICYmIHBhdGgubm9kZSA9PT0gcGF0aC5wYXJlbnQuYWx0ZXJuYXRlKSA6OlxuICAgICAgICAgICAga2V5d29yZCA9ICdlbHNlJyAvLyBmaXh1cCBpZi9lbHNlIGNvbWJpbmVkIHBhcmVudCBjb25kaXRpb25cblxuICAgICAgICAgIHRocm93IHBhdGguYnVpbGRDb2RlRnJhbWVFcnJvciBAXG4gICAgICAgICAgICBgS2V5d29yZCAnJHtrZXl3b3JkfScgc2hvdWxkIGJlIGZvbGxvd2VkIGJ5IGEgYmxvY2sgc3RhdGVtZW50IHVzaW5nICc6Oicgb3IgbWF0Y2hpbmcgJ3snIC8gJ30nLiBcXG5gICtcbiAgICAgICAgICAgIGAgICAgKEZyb20gJ2tleXdvcmRfYmxvY2tzJyBlbmZvcmNlbWVudCBvcHRpb24gb2YgYmFiZWwtcGx1Z2luLW9mZnNpZGUpYFxuXG5cbk9iamVjdC5hc3NpZ24gQCBleHBvcnRzLFxuICBAe31cbiAgICBob29rQmFieWxvbixcbiAgICBwYXJzZU9mZnNpZGVJbmRleE1hcCxcblxuIl19